<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–¼êµ´ ì¸ì‹ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upload-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }
        
        #imageInput {
            margin: 10px 0;
        }
        
        #testBtn, #testAllBtn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #testBtn:hover {
            background: #0056b3;
        }
        
        #testBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .preview-section {
            display: none;
            margin: 20px 0;
        }
        
        .image-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .image-box {
            text-align: center;
        }
        
        .image-box img {
            max-width: 300px;
            max-height: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .image-box h3 {
            margin: 10px 0 5px 0;
            color: #333;
        }
        
        .results-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .result-box {
            background: white;
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        
        .result-box h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .result-box pre {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #hiddenCanvas {
            display: none;
        }
        
        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .download-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ì–¼êµ´ ì¸ì‹ í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ</h1>
        
        <div class="upload-section">
            <h3>í…ŒìŠ¤íŠ¸í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
            <input type="file" id="imageInput" accept="image/*" multiple>
            <div id="fileCount" style="margin: 10px 0; color: #666;"></div>
            <button id="testBtn">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
            <button id="testAllBtn" style="display: none; margin-left: 10px;">ì „ì²´ í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...</p>
        </div>
        
        <div class="preview-section" id="previewSection">
            <h3>ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</h3>
            <div class="image-container">
                <div class="image-box">
                    <h4>ì›ë³¸ ì´ë¯¸ì§€</h4>
                    <img id="originalImage" src="" alt="ì›ë³¸ ì´ë¯¸ì§€">
                </div>
                <div class="image-box" id="faceImageBox" style="display: none;">
                    <h4>ì¶”ì¶œëœ ì–¼êµ´ ì˜ì—­</h4>
                    <img id="faceImage" src="" alt="ì–¼êµ´ ì˜ì—­">
                </div>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection" style="display: none;">
            <h3>í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
            <div id="results"></div>
        </div>
    </div>
    
    <!-- ì´ë¯¸ì§€ ì²˜ë¦¬ìš© ìˆ¨ê²¨ì§„ ìº”ë²„ìŠ¤ -->
    <canvas id="hiddenCanvas"></canvas>
    
    <script>
        // ì„¤ì •ê°’
        const MIN_FACE_RATIO = 0.1;
        const IMAGE_SCALE_FACTOR = 0.5;
        
        // ìš”ì†Œ ì°¸ì¡°
        const imageInput = document.getElementById('imageInput');
        const testBtn = document.getElementById('testBtn');
        const testAllBtn = document.getElementById('testAllBtn');
        const fileCount = document.getElementById('fileCount');
        const loading = document.getElementById('loading');
        const previewSection = document.getElementById('previewSection');
        const resultsSection = document.getElementById('resultsSection');
        const results = document.getElementById('results');
        const originalImage = document.getElementById('originalImage');
        const faceImage = document.getElementById('faceImage');
        const faceImageBox = document.getElementById('faceImageBox');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        
        // íŒŒì¼ ì„ íƒ ë³€ê²½ ì‹œ
        imageInput.onchange = function() {
            const files = this.files;
            if (files.length > 0) {
                fileCount.textContent = `${files.length}ê°œ íŒŒì¼ ì„ íƒë¨`;
                testBtn.style.display = 'inline-block';
                if (files.length > 1) {
                    testAllBtn.style.display = 'inline-block';
                } else {
                    testAllBtn.style.display = 'none';
                }
            } else {
                fileCount.textContent = '';
                testBtn.style.display = 'inline-block';
                testAllBtn.style.display = 'none';
            }
        };
        
        // ì²« ë²ˆì§¸ íŒŒì¼ë§Œ í…ŒìŠ¤íŠ¸
        testBtn.onclick = function() {
            const files = imageInput.files;
            if (files.length === 0) {
                alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            startTest(files[0]);
        };
        
        // ëª¨ë“  íŒŒì¼ í…ŒìŠ¤íŠ¸
        testAllBtn.onclick = function() {
            const files = imageInput.files;
            if (files.length === 0) {
                alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            startBatchTest(Array.from(files));
        };
        
        async function startTest(file) {
            showLoading(true);
            clearResults();
            
            try {
                // íŒŒì¼ì„ ì´ë¯¸ì§€ë¡œ ë¡œë“œ
                const originalImageData = await loadImageFromFile(file);
                
                // ì›ë³¸ ì´ë¯¸ì§€ í‘œì‹œ
                showOriginalImage(originalImageData.dataUrl);
                
                // 1ë‹¨ê³„: ì–¼êµ´ ê°ì§€
                addResult('1ë‹¨ê³„: ì–¼êµ´ ê°ì§€ ì¤‘...', 'info');
                const detectResult = await testDetectFace(originalImageData.base64);
                addResult('ì–¼êµ´ ê°ì§€ ê²°ê³¼', 'success', detectResult);
                
                if (detectResult.success && detectResult.face_detected) {  
                    // 2ë‹¨ê³„: ì–¼êµ´ ë¹„êµ
                    addResult('2ë‹¨ê³„: ì–¼êµ´ ë¹„êµ ì¤‘...', 'info');
                    const compareResult = await testCompareFace(originalImageData.base64);
                    addResult('ì–¼êµ´ ë¹„êµ ê²°ê³¼', 'success', compareResult);
                    
                    // ê²°ê³¼ ë¶„ì„
                    analyzeCompareResult(compareResult);
                   
                } else {
                    addResult('ì–¼êµ´ì´ ê°ì§€ë˜ì§€ ì•Šì•„ ë¹„êµ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.', 'error');
                }
                
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
                addResult('í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error', {error: error.message});
            } finally {
                showLoading(false);
            }
        }
        
        async function loadImageFromFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const base64 = e.target.result.split(',')[1];
                        resolve({
                            image: img,
                            dataUrl: e.target.result,
                            base64: base64
                        });
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function testDetectFace(imageData) {
            const response = await fetch('/api/detect-face', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({image: imageData})
            });
            return await response.json();
        }
        
        async function testCompareFace(imageData) {
            const response = await fetch('/api/compare-face', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({image: imageData})
            });
            return await response.json();
        }
        
        function analyzeCompareResult(compareResult) {
            if (compareResult.success) {
                if (compareResult.match_type === "high" && compareResult.best_match) {
                    addResult('âœ… ë†’ì€ ìœ ì‚¬ë„ ë§¤ì¹˜ (0.7 ì´ìƒ)', 'success', {
                        name: compareResult.best_match.name,
                        confidence: `${Math.round(compareResult.best_match.confidence * 100)}%`,
                        department: compareResult.best_match.department,
                        position: compareResult.best_match.position
                    });
                } else if (compareResult.match_type === "medium" && compareResult.candidates) {
                    addResult('âš ï¸ ì¤‘ê°„ ìœ ì‚¬ë„ ë§¤ì¹˜ (0.6-0.7)', 'info', {
                        candidates_count: compareResult.candidates.length,
                        candidates: compareResult.candidates.map(c => ({
                            name: c.name,
                            confidence: `${Math.round(c.confidence * 100)}%`
                        }))
                    });
                } else {
                    addResult('âŒ ë‚®ì€ ìœ ì‚¬ë„ (0.6 ë¯¸ë§Œ)', 'error', {
                        message: 'ì¼ì¹˜í•˜ëŠ” ì–¼êµ´ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'
                    });
                }
            } else {
                addResult('âŒ ì–¼êµ´ ë¹„êµ ì‹¤íŒ¨', 'error', compareResult);
            }
        }
        
        function showOriginalImage(dataUrl) {
            originalImage.src = dataUrl;
            previewSection.style.display = 'block';
        }
        
        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
            testBtn.disabled = show;
        }
        
        function clearResults() {
            results.innerHTML = '';
            resultsSection.style.display = 'none';
            previewSection.style.display = 'none';
            faceImageBox.style.display = 'none';
        }
        
        function addResult(title, type, data = null) {
            const resultBox = document.createElement('div');
            resultBox.className = 'result-box';
            
            let content = `<h4>${title}</h4>`;
            
            if (data) {
                content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            resultBox.innerHTML = content;
            results.appendChild(resultBox);
            resultsSection.style.display = 'block';
            
            // ìë™ ìŠ¤í¬ë¡¤
            resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ë°°ì¹˜ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ì¶”ê°€
        async function startBatchTest(files) {
            showLoading(true);
            clearResults();
            
            addResult(`ğŸš€ ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì‹œì‘ - ì´ ${files.length}ê°œ íŒŒì¼`, 'info');
            
            const results = {
                total: files.length,
                success: 0,
                faceDetected: 0,
                highMatch: 0,
                mediumMatch: 0,
                noMatch: 0,
                errors: 0,
                details: []
            };
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileNum = i + 1;
                
                addResult(`ğŸ“ [${fileNum}/${files.length}] ${file.name} ì²˜ë¦¬ ì¤‘...`, 'info');
                
                try {
                    const fileResult = await testSingleFile(file, fileNum);
                    results.details.push(fileResult);
                    
                    if (fileResult.success) {
                        results.success++;
                        if (fileResult.faceDetected) {
                            results.faceDetected++;
                            switch (fileResult.matchType) {
                                case 'high':
                                    results.highMatch++;
                                    break;
                                case 'medium':
                                    results.mediumMatch++;
                                    break;
                                case 'low':
                                    results.noMatch++;
                                    break;
                            }
                        }
                    } else {
                        results.errors++;
                    }
                    
                    // 1ì´ˆ ëŒ€ê¸° (ì„œë²„ ë¶€í•˜ ë°©ì§€)
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                } catch (error) {
                    console.error(`íŒŒì¼ ${file.name} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, error);
                    results.errors++;
                    results.details.push({
                        fileName: file.name,
                        success: false,
                        error: error.message
                    });
                }
            }

            console.log('ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼:', results);
            
            // ìµœì¢… ê²°ê³¼ ìš”ì•½
            addBatchSummary(results);
        }
        
        async function testSingleFile(file, fileNum) {
            try {
                const originalImageData = await loadImageFromFile(file);
                
                // 1ë‹¨ê³„: ì–¼êµ´ ê°ì§€
                const detectResult = await testDetectFace(originalImageData.base64);
                
                const result = {
                    fileName: file.name,
                    fileNum: fileNum,
                    success: true,
                    detectResult: detectResult,
                    faceDetected: detectResult.success && detectResult.face_detected,
                    matchType: null,
                    compareResult: null,
                    bestMatch: null,
                    candidates: null,
                    error: null
                };
                
                if (result.faceDetected) {
                    
                    // 2ë‹¨ê³„: ì–¼êµ´ ë¹„êµ
                    const compareResult = await testCompareFace(originalImageData.base64);
                    result.compareResult = compareResult;
                    
                    if (compareResult.success) {
                        result.matchType = compareResult.match_type;
                        
                        // ê²°ê³¼ë³„ ìƒì„¸ ì •ë³´ ì¶”ê°€
                        if (compareResult.match_type === 'high' && compareResult.best_match) {
                            result.bestMatch = {
                                name: compareResult.best_match.name,
                                confidence: compareResult.best_match.confidence
                            };
                            addResult(`âœ… [${fileNum}] ${file.name}: ë†’ì€ ìœ ì‚¬ë„ ë§¤ì¹˜ - ${compareResult.best_match.name} (${Math.round(compareResult.best_match.confidence * 100)}%)`, 'success');
                        } else if (compareResult.match_type === 'medium' && compareResult.candidates) {
                            result.candidates = compareResult.candidates.map(c => ({
                                name: c.name,
                                confidence: c.confidence
                            }));
                            addResult(`âš ï¸ [${fileNum}] ${file.name}: ì¤‘ê°„ ìœ ì‚¬ë„ ë§¤ì¹˜ - ${compareResult.candidates.length}ëª… í›„ë³´`, 'info');
                        } else {
                            result.matchType = 'low';
                            addResult(`âŒ [${fileNum}] ${file.name}: ë§¤ì¹˜ ì—†ìŒ`, 'error');
                        }
                    } else {
                        result.error = compareResult.error || 'ë¹„êµ ì‹¤íŒ¨';
                    }
                } else {
                    addResult(`ğŸ˜” [${fileNum}] ${file.name}: ì–¼êµ´ ê°ì§€ ì‹¤íŒ¨`, 'error');
                }
                
                return result;
                
            } catch (error) {
                addResult(`ğŸ’¥ [${fileNum}] ${file.name}: ì²˜ë¦¬ ì˜¤ë¥˜ - ${error.message}`, 'error');
                throw error;
            }
        }
        
        function addBatchSummary(results) {
            showLoading(false);

            const summary = {
                'ğŸ“Š ì „ì²´ í†µê³„': {
                    'ì´ íŒŒì¼ ìˆ˜': results.total,
                    'ì„±ê³µ ì²˜ë¦¬': results.success,
                    'ì–¼êµ´ ê°ì§€ ì„±ê³µ': results.faceDetected,
                    'ë†’ì€ ìœ ì‚¬ë„ ë§¤ì¹˜': results.highMatch,
                    'ì¤‘ê°„ ìœ ì‚¬ë„ ë§¤ì¹˜': results.mediumMatch,
                    'ë§¤ì¹˜ ì—†ìŒ': results.noMatch,
                    'ì˜¤ë¥˜ ë°œìƒ': results.errors
                },
                'ğŸ“ˆ ì„±ê³µë¥ ': {
                    'ì „ì²´ ì„±ê³µë¥ ': `${Math.round((results.success / results.total) * 100)}%`,
                    'ì–¼êµ´ ê°ì§€ë¥ ': `${Math.round((results.faceDetected / results.total) * 100)}%`,
                    'ë§¤ì¹˜ ì„±ê³µë¥ ': results.faceDetected > 0 ? `${Math.round(((results.highMatch + results.mediumMatch) / results.faceDetected) * 100)}%` : '0%'
                }
            };
            
            addResult('ğŸ¯ ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ - ìµœì¢… ìš”ì•½', 'success', summary);
            
            // CSV ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¶”ê°€
            addDownloadCSVButton(results);
        }
        
        function addDownloadCSVButton(results) {
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'ğŸ“¥ ê²°ê³¼ë¥¼ CSVë¡œ ë‹¤ìš´ë¡œë“œ';
            downloadBtn.className = 'download-btn';
            
            downloadBtn.onclick = function() {
                downloadResultsAsCSV(results);
            };
            
            resultsSection.appendChild(downloadBtn);
        }
        
        function downloadResultsAsCSV(results) {
            // UTF-8 BOMì„ í¬í•¨í•œ CSV í—¤ë”
            const bom = '\uFEFF';
            const csvHeaders = ['íŒŒì¼ëª…', 'ì–¼êµ´ê°ì§€', 'ë§¤ì¹˜íƒ€ì…', 'ë§¤ì¹˜ì´ë¦„', 'ìœ ì‚¬ë„', 'ì—ëŸ¬'];
            const csvRows = [csvHeaders.join(',')];
            
            results.details.forEach(detail => {
                // ê° í•„ë“œë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                const fileName = `"${detail.fileName || ''}"`;
                const faceDetected = detail.faceDetected ? 'O' : 'X';
                const matchType = detail.matchType || '';
                
                // ë§¤ì¹˜ ì´ë¦„ ì²˜ë¦¬
                let matchName = '';
                if (detail.bestMatch && detail.bestMatch.name) {
                    matchName = `"${detail.bestMatch.name}"`;
                } else if (detail.candidates && detail.candidates.length > 0) {
                    // ì¤‘ê°„ ë§¤ì¹˜ì˜ ê²½ìš° ì²« ë²ˆì§¸ í›„ë³´ì ì´ë¦„
                    matchName = `"${detail.candidates[0].name}"`;
                }
                
                // ìœ ì‚¬ë„ ì²˜ë¦¬
                let similarity = '';
                if (detail.bestMatch && detail.bestMatch.confidence !== undefined) {
                    similarity = Math.round(detail.bestMatch.confidence * 100) + '%';
                } else if (detail.candidates && detail.candidates.length > 0 && detail.candidates[0].confidence !== undefined) {
                    similarity = Math.round(detail.candidates[0].confidence * 100) + '%';
                }
                
                // ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
                const errorMsg = detail.error ? `"${detail.error}"` : '';
                
                const row = [fileName, faceDetected, matchType, matchName, similarity, errorMsg];
                csvRows.push(row.join(','));
            });
            
            // BOMì„ í¬í•¨í•œ CSV ë‚´ìš© ìƒì„±
            const csvContent = bom + csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `ì–¼êµ´ì¸ì‹_í…ŒìŠ¤íŠ¸ê²°ê³¼_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // URL ê°ì²´ í•´ì œ
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>